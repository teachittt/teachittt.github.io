<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Data & Email</title>
  <style>
    body {
      font-family: monospace;
      background-color: #1a1a1a; /* สีพื้นหลังดำเทา */
      color: #00ff00; /* สีเขียวสไตล์ Terminal */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
    }

    .version-tag {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #007bff; /* ป้ายสีฟ้า */
      color: white;
      padding: 3px 6px;
      font-size: 10px;
      border-radius: 3px;
      font-family: sans-serif;
    }

    .card {
      background: #2d2d2d;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px; /* ขยายกว้างขึ้นหน่อยเผื่อ Email ยาว */
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      margin-top: 30px;
      border: 1px solid #444;
    }

    img.avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #00ff00;
      display: block;
      margin: 0 auto 15px;
    }

    h3 { text-align: center; color: #fff; margin: 0 0 20px 0; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { text-align: left; color: #aaa; padding: 8px 5px; border-bottom: 1px solid #444; width: 30%; }
    td { text-align: right; color: #fff; padding: 8px 5px; border-bottom: 1px solid #444; word-break: break-all; }

    /* ไฮไลท์แถว Email */
    .row-email td { color: #ffeb3b; font-weight: bold; }

    .countdown {
      text-align: center;
      font-size: 18px;
      margin-top: 25px;
      color: #fff;
      background: #333;
      padding: 10px;
      border-radius: 5px;
    }
    .countdown span { color: #ff0000; font-weight: bold; font-size: 22px; }
  </style>
</head>
<body>

  <div class="version-tag">VER: WITH EMAIL</div>

  <div class="card">
    <img id="u-img" class="avatar" src="">
    <h3 id="u-name">Loading...</h3>

    <table>
      <tr><th>User ID</th><td id="u-id">...</td></tr>
      <tr class="row-email"><th>Email</th><td id="u-email">...</td></tr> <tr><th>Status</th><td id="u-status">...</td></tr>
      <tr><th>OS</th><td id="u-os">...</td></tr>
      <tr><th>Lang</th><td id="u-lang">...</td></tr>
    </table>

    <div class="countdown">
      Redirect in <span id="timer">5</span> s
    </div>
  </div>

  <p id="debug-log" style="font-size:10px; color:gray; margin-top:20px; text-align:center;"></p>

  <script src="https://static.line-scdn.net/liff/edge/versions/2.9.0/sdk.js"></script>
  <script>
    // --- อย่าลืมใส่ LIFF ID ของคุณ ---
    const MY_LIFF_ID = "1655725335-HvHozKEr"; 

    function runApp() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetUrl = urlParams.get('target');

      liff.getProfile().then(profile => {
        // 1. ดึงข้อมูล User Profile ปกติ
        document.getElementById("u-img").src = profile.pictureUrl || "https://via.placeholder.com/80";
        document.getElementById("u-name").innerText = profile.displayName;
        document.getElementById("u-id").innerText = profile.userId;
        document.getElementById("u-status").innerText = profile.statusMessage || "-";
        
        // 2. ดึง Email จาก ID Token **(จุดสำคัญ)**
        const idToken = liff.getDecodedIDToken();
        if (idToken && idToken.email) {
            document.getElementById("u-email").innerText = idToken.email;
        } else {
            document.getElementById("u-email").innerText = "No Permission / Not Found";
            // ถ้าขึ้นข้อความนี้ แสดงว่ายังไม่ได้เปิด Scope Email ใน Console หรือ User ไม่กดอนุญาต
        }

        // 3. ข้อมูล Device
        document.getElementById("u-os").innerText = liff.getOS();
        document.getElementById("u-lang").innerText = liff.getLanguage();

        // 4. Countdown Redirect
        if (targetUrl) {
          let count = 10;
          const timerEl = document.getElementById("timer");
          const interval = setInterval(() => {
            count--;
            timerEl.innerText = count;
            if (count <= 0) {
              clearInterval(interval);
              window.location.replace(targetUrl);
            }
          }, 1000);
        } else {
          document.getElementById("debug-log").innerText = "Warning: No target URL provided.";
        }

      }).catch(err => {
        document.getElementById("u-name").innerText = "Error!";
        document.getElementById("debug-log").innerText = err;
      });
    }

    liff.init({ liffId: MY_LIFF_ID }, () => {
      if (liff.isLoggedIn()) {
        runApp();
      } else {
        // ตอน Login ต้องขอ Scope เพิ่มด้วย (แต่ถ้าตั้งใน Console แล้ว ปกติจะ auto)
        liff.login({ redirectUri: window.location.href });
      }
    }, err => alert("Init Error: " + err));
  </script>
</body>
</html>
